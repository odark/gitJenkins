pipeline {
    agent any
    environment {
        DOCKERFILE = "Dockerfile"
        dockerHubRegistry = 'odark/webserver'
        dockerHubRegistryCredential = 'dockerhub'
    }
    stages {
    	stage('Clone repository') {
            steps {
                script {
                    checkout scm
                }
            }
    	}
        stage('Env Variables') {
            steps {
                echo "The build number is ${env.BUILD_NUMBER}"
                echo "You can also use \${BUILD_NUMBER} -> ${BUILD_NUMBER}"
                sh 'echo "I can access $BUILD_NUMBER in shell comman as well."'
            }
        }
    
        stage('Build image') {
            steps {
            //dockerfile       = 'Dockerfile'
                script {
                    docker.build("${dockerHubRegistry}:${env.BUILD_NUMBER}", "-f ${DOCKERFILE} ./")
                }
            }
        }
        stage('Image Push') {
            steps {
                script {
                    // withCredentials 블록을 사용하여 Credential ID의 정보를 가져옴
                    withDockerRegistry([ credentialsId: dockerHubRegistryCredential, url: "https://registry.hub.docker.com" ]) {
                        //sh "docker push webserver:${env.BUILD_NUMBER}"
                        sh "docker push ${dockerHubRegistry}:${env.BUILD_NUMBER}"
                        //sh "docker push ${dockerHubRegistry}:latest"

                        //sleep 10 /* Wait uploading */ 
                    }
                }
            }
        }
    }
}